<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>사진 업로드 및 보기</title>
    <style>
      .photo-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        margin: 20px;
      }
      .photo-item {
        margin: 10px;
      }
      .photo-item img {
        width: 200px; /* 사진 크기를 동일하게 설정 */
        height: 200px;
        object-fit: cover; /* 사진을 잘라내서라도 지정된 크기에 맞춤 */
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .form-container {
        margin: 20px;
        text-align: center;
      }
      .form-container input[type="file"] {
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>사진 업로드 및 보기</h1>

    <div class="form-container">
      <input type="date" id="photoDate" placeholder="날짜" />
      <input type="file" id="photoInput" accept="image/*" placeholder="사진" />
      <button onclick="uploadPhoto()">사진 업로드</button>
    </div>

    <div id="photoList" class="photo-container">
      <!-- 사진 항목이 여기에 동적으로 추가됩니다 -->
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Firebase SDK 모듈 가져오기
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
      import {
        getStorage,
        ref,
        uploadBytes,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";
      import {
        getFirestore,
        collection,
        doc,
        addDoc,
        getDocs,
        query,
      } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

      // Firebase 프로젝트 구성
      const firebaseConfig = {
        apiKey: "AIzaSyCx_AlSQLpW-KpYXpk0M2mDxVb7CZa_xUk",
        authDomain: "diet-king-b567d.firebaseapp.com",
        projectId: "diet-king-b567d",
        storageBucket: "diet-king-b567d.appspot.com",
        messagingSenderId: "11155339798",
        appId: "1:11155339798:web:f689c9f8b8c772c65cc3e4",
        measurementId: "G-9NNCPJMT9M",
      };

      // Firebase 초기화
      const app = initializeApp(firebaseConfig);
      const storage = getStorage(app);
      const firestore = getFirestore(app);

      // URL에서 클라이언트 ID 추출
      function getClientIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("clientId");
      }

      // 사진 업로드
      async function uploadPhoto() {
        const clientId = getClientIdFromURL();
        if (!clientId)
          return alert("클라이언트 ID가 URL에 포함되어 있지 않습니다.");

        const photoDate = document.getElementById("photoDate").value;
        const photoFile = document.getElementById("photoInput").files[0];
        if (!photoDate || !photoFile) return alert("날짜와 사진을 입력하세요.");

        try {
          const photoUrl = await uploadSinglePhoto(
            clientId,
            photoFile,
            photoDate
          );

          // Firestore에 사진 URL을 추가로 저장
          await addDoc(
            collection(firestore, "photoRecords", clientId, "photos"),
            {
              date: photoDate,
              photoUrl: photoUrl,
            }
          );
          alert("사진 업로드 완료!");

          // 파일 선택 초기화
          document.getElementById("photoInput").value = "";

          // 사진 리스트 업데이트
          displayPhotos();
        } catch (error) {
          console.error("사진 업로드 중 오류 발생:", error);
        }
      }

      // 사진 업로드 함수 (타임스탬프를 사용해 파일명 고유화)
      async function uploadSinglePhoto(clientId, file, date) {
        const timestamp = new Date().getTime();
        const storageRef = ref(
          storage,
          `photos/${clientId}/${date}_${timestamp}.jpg`
        );
        await uploadBytes(storageRef, file);
        return getDownloadURL(storageRef);
      }

      // 모든 사진 표시
      async function displayPhotos() {
        const clientId = getClientIdFromURL();
        if (!clientId)
          return console.error("클라이언트 ID가 URL에 포함되어 있지 않습니다.");

        const photoList = document.getElementById("photoList");
        photoList.innerHTML = ""; // 기존 항목 초기화

        try {
          const q = query(
            collection(firestore, "photoRecords", clientId, "photos")
          );
          const querySnapshot = await getDocs(q);
          querySnapshot.forEach((doc) => {
            const photoData = doc.data();
            const container = document.createElement("div");
            container.className = "photo-item";
            container.innerHTML = `
                        <div>
                            <h3>${photoData.date} 사진</h3>
                            <img src="${photoData.photoUrl}" alt="사진">
                        </div>
                    `;
            photoList.appendChild(container);
          });
        } catch (error) {
          console.error("사진 로드 중 오류 발생:", error);
        }
      }

      // 함수들을 전역 스코프에 할당
      window.uploadPhoto = uploadPhoto;
      window.displayPhotos = displayPhotos;

      // 페이지 로드 시 사진 표시
      window.onload = displayPhotos;
    </script>
  </body>
</html>
