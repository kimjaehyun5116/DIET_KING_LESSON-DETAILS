<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>레슨 일지 작성</title>
    <style>
      /* 기존 스타일은 그대로 유지됩니다 */
      body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        height: 100vh;
        overflow: hidden;
      }

      .container {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 800px;
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        height: 90vh;
        max-height: 800px;
        overflow: auto;
      }

      .header {
        text-align: center;
        margin-bottom: 20px;
      }

      #clientName {
        font-size: 24px;
        color: #333;
        margin: 0;
        padding: 0px 0;
      }

      .exercise-group {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        background-color: #fff;
        position: relative;
      }

      .exercise-group:last-child {
        margin-bottom: 0;
      }

      .form-group {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 16px;
        resize: vertical;

        margin-bottom: 5px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #555;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 16px;
      }

      .form-group textarea {
        resize: vertical;
      }

      .btn {
        width: 100%;
        padding: 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
        text-align: center;
        font-size: 16px;
      }

      .btn:hover {
        background-color: #0056b3;
      }

      .add-remove-buttons {
        display: flex;
        justify-content: flex-end;
        margin-top: 10px;
      }

      .add-remove-buttons button {
        border: none;
        background-color: #007bff;
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 20px;
        cursor: pointer;
        margin-left: 5px;
      }

      .remove-btn {
        background-color: #dc3545;
      }

      .remove-btn:hover {
        background-color: #c82333;
      }

      .add-btn:hover {
        background-color: #0056b3;
      }

      .exercise-group-table {
        width: 100%;
        border-collapse: collapse;
      }

      .exercise-group-table th,
      .exercise-group-table td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }

      .exercise-group-table th {
        background-color: #f4f4f4;
      }

      .add-group-btn {
        display: flex;
        justify-content: center;
        margin-top: 20px;
      }

      .add-group-btn button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }

      .add-group-btn button:hover {
        background-color: #0056b3;
      }

      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .close-btn:hover {
        background-color: #c82333;
      }

      .youtube-search-btn {
        display: inline-block;
        padding: 10px 20px;
        background-color: #ff0000;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        text-align: center;
        margin-top: 10px;
      }

      .youtube-search-btn:hover {
        background-color: #cc0000;
      }

      .header h1 {
        text-align: center;
      }

      /* 숨기기 위한 스타일 추가 */
      #addGroupBtn,
      .close-btn,
      .add-remove-buttons,
      #saveLessonBtn {
        display: none;
      }

      /* 텍스트 필드를 비활성화하는 스타일 추가 */
      .form-group input[disabled],
      .form-group textarea[disabled] {
        background-color: #e9ecef;
        cursor: not-allowed;
      }
      .header {
        display: flex;
        align-items: center; /* 세로 정렬 */
        justify-content: center;
        margin-bottom: 0px;
      }

      /* 헤더 스타일 */
      .header {
        display: flex;
        align-items: center; /* 세로 정렬 */
        justify-content: center; /* 중앙 정렬 */
        margin-bottom: 20px; /* 헤더와 본문 사이의 간격 */
      }

      /* 헤더 제목 스타일 */
      .header-title {
        display: flex;
        align-items: center;
        margin-right: 10px; /* 카카오톡 버튼과의 간격 */
      }

      /* 제목 스타일 */
      .header-title h1 {
        margin: 0;
        font-size: 20px;
        color: #333;
        padding: 20px 0;
      }

      /* 카카오톡 공유 버튼 스타일 */
      .kakao-share-btn {
        background-color: transparent; /* 배경색 제거 */
        color: black; /* 텍스트 색상 제거 */
        border: none;
        border-radius: 50%;
        width: 40px; /* 버튼 너비 */
        height: 40px; /* 버튼 높이 */
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .kakao-share-btn img {
        width: 24px; /* 이미지 너비 */
        height: 24px; /* 이미지 높이 */
      }
      .feedback-section {
        display: flex;
        flex-direction: column;
        align-items: center; /* 수평 중앙 정렬 */
        margin-top: 20px; /* 위쪽 여백 */
      }

      /* 모바일 화면에서 테이블 헤더 글자 크기 줄이기 */
      @media (max-width: 600px) {
        .form-group {
          font-size: 12px;
        }
        .exercise-group-table th,
        .exercise-group-table td {
          font-size: 11px; /* 원하는 글자 크기로 조정 */
        }
      }
      .exercise-group-table th,
      .exercise-group-table td {
        border: 1px solid #ddd;
        padding: 2px;
        text-align: center;
      }

      .exercise-group-table th {
        background-color: #f4f4f4;
      }

      .exercise-group-table td:nth-child(1),
      .exercise-group-table th:nth-child(1) {
        width: 10%; /* 세트 열 너비 */
      }

      .exercise-group-table td:nth-child(2),
      .exercise-group-table th:nth-child(2) {
        width: 30%; /* 무게 열 너비 */
      }

      .exercise-group-table td:nth-child(3),
      .exercise-group-table th:nth-child(3) {
        width: 30%; /* 횟수 열 너비 */
      }
      .exercise-group-table input[type="number"] {
        height: 10px; /* 원하는 높이로 조정 */
        font-size: 11px;
        text-align: center;
      }
      .form-group #exerciseBodyPart1,
      .form-group #exerciseName1 {
        height: 10px;
      }
      .next_lesson {
        width: 100%; /* 부모 요소의 너비를 100%로 설정 */
        margin-top: 20px; /* 위쪽 여백 추가 */
      }

      .next_lesson textarea {
        width: 100%; /* 부모 요소에 꽉 차도록 설정 */
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 14px;
        resize: vertical; /* 수직으로만 크기 조절 가능 */
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="header-title">
          <h1 id="clientName">레슨 일지</h1>
        </div>
        <button class="kakao-share-btn" onclick="shareOnKakao()">
          <img
            src="https://firebasestorage.googleapis.com/v0/b/diet-king-b567d.appspot.com/o/img%2F%E1%84%8F%E1%85%A1%E1%84%90%E1%85%A9%E1%86%A8%E1%84%85%E1%85%A9%E1%84%80%E1%85%A9.jpeg?alt=media&token=fd001f3f-9d99-4526-968e-1952b1e33119"
            alt="카카오톡 공유"
          />
        </button>
      </div>

      <div id="message"></div>
      <div id="exerciseGroupsContainer">
        <!-- 운동 그룹들이 동적으로 추가될 위치 -->
      </div>
      <div class="next_lesson">
        <textarea
          id="exerciseDescription${groupIndex}"
          rows="4"
          placeholder="다음 회차 예정 수업을 입력하세요"
          disabled
        ></textarea>
      </div>
      <div class="add-group-btn">
        <button class="btn" id="addGroupBtn">종목 추가</button>
      </div>
      <input type="hidden" id="lessonId" />
      <button class="btn" id="saveLessonBtn">저장</button>
      <!-- <button class="btn" onclick="goBack()">뒤로 가기</button> -->
      <!-- <button class="btn" id="viewReadOnlyBtn">읽기 전용 페이지로 이동</button> -->
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>

    <script>
      // Firebase 설정
      const firebaseConfig = {
        apiKey: "AIzaSyCx_AlSQLpW-KpYXpk0M2mDxVb7CZa_xUk",
        authDomain: "diet-king-b567d.firebaseapp.com",
        projectId: "diet-king-b567d",
        storageBucket: "diet-king-b567d.appspot.com",
        messagingSenderId: "11155339798",
        appId: "1:11155339798:web:f689c9f8b8c772c65cc3e4",
        measurementId: "G-9NNCPJMT9M",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // 클라이언트 ID 가져오기
      function getClientId() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("clientId");
      }

      // 레슨 ID 가져오기
      function getLessonId() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("lessonId");
      }

      document.addEventListener("DOMContentLoaded", function () {
        const addGroupBtn = document.getElementById("addGroupBtn");
        const saveLessonBtn = document.getElementById("saveLessonBtn");
        const exerciseGroupsContainer = document.getElementById(
          "exerciseGroupsContainer"
        );
        const viewReadOnlyBtn = document.getElementById("viewReadOnlyBtn");
        const lessonIdInput = document.getElementById("lessonId");

        // 레슨 데이터 로드 함수
        async function loadLessonData() {
          const lessonId = getLessonId();
          const clientId = getClientId();

          if (lessonId) {
            try {
              const lessonDoc = await db
                .collection("lessons")
                .doc(lessonId)
                .get();
              if (lessonDoc.exists) {
                const lessonData = lessonDoc.data();
                lessonIdInput.value = lessonId;

                const exerciseGroups = lessonData.exerciseGroups || [];
                exerciseGroups.forEach((group, index) => {
                  createExerciseGroup(group, index + 1);
                });

                document.querySelector(".next_lesson textarea").value =
                  lessonData.nextLesson || "";

                // 클라이언트 정보 로드 및 업데이트
                if (clientId) {
                  await loadClientCycleData(clientId, lessonData.cycle);
                } else {
                  console.log("클라이언트 ID가 입력되지 않았습니다.");
                }
              } else {
                console.log("레슨 문서를 찾을 수 없습니다.");
              }
            } catch (error) {
              console.error("레슨 데이터 로드 중 오류 발생:", error);
              alert("레슨 데이터를 로드하는 중 오류가 발생했습니다.");
            }
          } else {
            console.log("레슨 ID가 입력되지 않았습니다.");
          }
        }

        // 클라이언트 사이클 데이터 로드 함수
        async function loadClientCycleData(clientId, cycle) {
          // cycle 정보를 사용하여 클라이언트 이름 업데이트
          updateClientName(cycle);
        }

        // 클라이언트 이름 업데이트 함수
        function updateClientName(cycle) {
          const clientNameElement = document.getElementById("clientName");
          clientNameElement.textContent = `${cycle}회차 레슨 일지`;
        }

        // 운동 그룹 생성
        function createExerciseGroup(groupData = {}, index) {
          // 사용 가능한 인덱스 중 하나를 가져오거나 새 인덱스를 생성
          const groupIndex = index || Math.max(...availableIndexes) + 1;

          availableIndexes.add(groupIndex); // 인덱스 집합에 추가

          const groupDiv = document.createElement("div");
          groupDiv.classList.add("exercise-group");
          groupDiv.id = `exerciseGroup${groupIndex}`;

          groupDiv.innerHTML = `
    <button class="close-btn" onclick="handleRemoveGroup('${groupDiv.id}')">&times;</button>
    <div class="form-group">
        <label for="exerciseName${groupIndex}">종목 ${groupIndex}</label>
        <input type="text" id="exerciseName${groupIndex}" placeholder="운동 이름을 입력하세요" disabled />
        
    </div>
    <div class="form-group">
        <label for="exerciseBodyPart${groupIndex}">부위</label>
        <input type="text" id="exerciseBodyPart${groupIndex}" placeholder="운동 부위를 입력하세요" disabled />
    </div>
    <div class="form-group">
        <label for="exerciseTable${groupIndex}"></label>
        <table id="exerciseTable${groupIndex}" class="exercise-group-table">
            <thead>
                <tr>
                    <th>세트</th>
                    <th>무게</th>
                    <th>횟수</th>
                </tr>
            </thead>
            <tbody id="exerciseTableBody${groupIndex}">
                <!-- 세트 정보가 여기에 추가됨 -->
            </tbody>
        </table>
    </div>
    <div class="feedback-section">
        <div class="form-group">
            <label for="exerciseDescription${groupIndex}">피드백</label>
            <textarea id="exerciseDescription${groupIndex}" rows="4" placeholder="운동에 대한 피드백을 입력하세요" disabled></textarea>
        </div>
        <button class="youtube-search-btn" onclick="searchYouTube('${groupIndex}')">유튜브 검색</button>
        <div class="add-remove-buttons">
            <button class="btn add-btn" id="addSetBtn${groupIndex}" disabled>+</button>
            <button class="btn remove-btn" id="removeSetBtn${groupIndex}" disabled>-</button>
        </div>
    </div>
  `;

          exerciseGroupsContainer.appendChild(groupDiv);

          const addSetBtn = document.getElementById(`addSetBtn${groupIndex}`);
          const removeSetBtn = document.getElementById(
            `removeSetBtn${groupIndex}`
          );
          const exerciseTableBody = document.getElementById(
            `exerciseTableBody${groupIndex}`
          );

          let setCount = 0;

          addSetBtn.addEventListener("click", function () {
            setCount++;
            const row = document.createElement("tr");
            const setCell = document.createElement("td");
            setCell.textContent = setCount;
            row.appendChild(setCell);
            const weightCell = document.createElement("td");
            const weightInput = document.createElement("input");
            weightInput.type = "number";
            weightInput.placeholder = "무게";
            weightInput.disabled = true; // 무게 입력 필드 수정 불가
            weightCell.appendChild(weightInput);
            row.appendChild(weightCell);
            const repsCell = document.createElement("td");
            const repsInput = document.createElement("input");
            repsInput.type = "number";
            repsInput.placeholder = "횟수";
            repsInput.disabled = true; // 횟수 입력 필드 수정 불가
            repsCell.appendChild(repsInput);
            row.appendChild(repsCell);
            exerciseTableBody.appendChild(row);
          });

          removeSetBtn.addEventListener("click", function () {
            if (setCount > 0) {
              exerciseTableBody.removeChild(exerciseTableBody.lastChild);
              setCount--;
            }
          });

          // 기존 데이터 로드
          if (groupData) {
            document.getElementById(`exerciseName${groupIndex}`).value =
              groupData.name || "";
            document.getElementById(`exerciseBodyPart${groupIndex}`).value =
              groupData.bodyPart || "";

            const exercises = groupData.exercises || [];
            exercises.forEach((exercise, setIndex) => {
              const row = document.createElement("tr");
              const setCell = document.createElement("td");
              setCell.textContent = setIndex + 1;
              row.appendChild(setCell);
              const weightCell = document.createElement("td");
              const weightInput = document.createElement("input");
              weightInput.type = "number";
              weightInput.value = exercise.weight || "";
              weightInput.placeholder = "무게";
              weightInput.disabled = true; // 무게 입력 필드 수정 불가
              weightCell.appendChild(weightInput);
              row.appendChild(weightCell);
              const repsCell = document.createElement("td");
              const repsInput = document.createElement("input");
              repsInput.type = "number";
              repsInput.value = exercise.reps || "";
              repsInput.placeholder = "횟수";
              repsInput.disabled = true; // 횟수 입력 필드 수정 불가
              repsCell.appendChild(repsInput);
              row.appendChild(repsCell);
              exerciseTableBody.appendChild(row);
            });

            // 피드백 로드
            document.getElementById(`exerciseDescription${groupIndex}`).value =
              groupData.feedback || "";
          }
        }

        // 유튜브 검색
        window.searchYouTube = function (index) {
          const exerciseName = document.getElementById(
            `exerciseName${index}`
          ).value;
          if (exerciseName) {
            const searchQuery = encodeURIComponent(exerciseName);
            const youtubeUrl = `https://www.youtube.com/results?search_query=${searchQuery}`;
            window.open(youtubeUrl, "_blank");
          } else {
            alert("운동 이름을 입력해주세요.");
          }
        };

        // 운동 그룹 제거
        window.handleRemoveGroup = function (groupId) {
          const groupDiv = document.getElementById(groupId);
          if (groupDiv) {
            // 인덱스 추출 및 집합에서 제거
            const index = parseInt(groupId.replace("exerciseGroup", ""), 10);
            availableIndexes.delete(index);

            exerciseGroupsContainer.removeChild(groupDiv);
          }
        };

        // 레슨 데이터 저장
        saveLessonBtn.addEventListener("click", async function () {
          const clientId = getClientId();
          if (!clientId) {
            alert("클라이언트 ID를 찾을 수 없습니다.");
            return;
          }

          const lessonId = lessonIdInput.value;
          const exerciseGroups = Array.from(
            exerciseGroupsContainer.children
          ).map((groupDiv) => {
            const index = groupDiv.id.replace("exerciseGroup", "");
            return {
              name: document.getElementById(`exerciseName${index}`).value,
              bodyPart: document.getElementById(`exerciseBodyPart${index}`)
                .value,
              exercises: Array.from(
                document.getElementById(`exerciseTableBody${index}`).children
              ).map((row) => {
                return {
                  weight: row.children[1].querySelector("input").value,
                  reps: row.children[2].querySelector("input").value,
                };
              }),
              feedback: document.getElementById(`exerciseDescription${index}`)
                .value, // 피드백 데이터 추가
            };
          });

          const lessonData = {
            clientId: clientId,
            exerciseGroups: exerciseGroups,
            lessonIndex: document
              .getElementById("clientName")
              .textContent.replace("회차 레슨 일지", "")
              .trim(),
          };

          try {
            if (lessonId) {
              await db.collection("lessons").doc(lessonId).update(lessonData);
              alert("레슨이 업데이트되었습니다.");
            } else {
              await db.collection("lessons").add(lessonData);
              alert("새 레슨이 추가되었습니다.");
            }
            // window.location.href = "index.html"; // 데이터 저장 후 이동할 페이지
          } catch (error) {
            console.error("레슨 저장 중 오류 발생:", error);
            alert("레슨을 저장하는 중 오류가 발생했습니다.");
          }
        });

        // 새로운 운동 그룹 추가 버튼 클릭 이벤트
        addGroupBtn.addEventListener("click", function () {
          createExerciseGroup({}, null);
        });

        // 페이지 로드 시 레슨 데이터 로드
        loadLessonData();

        // // 읽기 전용 페이지로 이동 버튼 클릭 이벤트
        // viewReadOnlyBtn.addEventListener("click", function () {
        //   const lessonId = lessonIdInput.value;
        //   if (lessonId) {
        //     window.location.href = `read_only.html?lessonId=${lessonId}`;
        //   } else {
        //     alert("레슨 ID를 찾을 수 없습니다.");
        //   }
        // });
      });

      // 뒤로 가기 버튼 클릭 이벤트
      function goBack() {
        window.history.back();
      }

      // 카카오톡 SDK 초기화
      Kakao.init("574e770008e383cdbdb1389d4f4074c1"); // 카카오톡 JavaScript SDK 키로 대체

      function shareOnKakao() {
        const title = document.getElementById("clientName").textContent;
        const url = window.location.href; // 현재 페이지 URL

        // 현재 날짜를 포맷하기 위한 함수
        function formatDate(date) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, "0"); // 월은 0부터 시작하므로 +1
          const day = String(date.getDate()).padStart(2, "0");
          return `${year}-${month}-${day}`;
        }

        const todayDate = formatDate(new Date()); // 현재 날짜 포맷

        Kakao.Link.sendDefault({
          objectType: "feed",
          content: {
            title: `${todayDate} 일지 업로드 완료`,
            description: `참고하시어 개인 운동에 적용하세요.`, // 날짜와 함께 레슨 일지 제목 설정
            imageUrl:
              "https://firebasestorage.googleapis.com/v0/b/diet-king-b567d.appspot.com/o/img%2Feggymlogo.png?alt=media&token=317444a9-00a5-427f-8d89-7ec4bd6842e6", // 썸네일 이미지 URL
            link: {
              mobileWebUrl: url,
              webUrl: url,
            },
          },
          buttons: [
            {
              title: "자세히 보기",
              link: {
                mobileWebUrl: url,
                webUrl: url,
              },
            },
          ],
        });
      }
      // 사용 가능한 인덱스를 저장할 집합
      const availableIndexes = new Set();
    </script>
  </body>
</html>
