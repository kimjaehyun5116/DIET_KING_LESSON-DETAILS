<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>식단 게시판</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #e9ebee;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        height: 100vh;
        margin: 0;
        padding-top: 50px;
      }

      .container {
        width: 100%;
        max-width: 500px;
        background: #ffffff;
        padding: 20px;
        border: 1px solid #dddfe2;
        border-radius: 8px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        font-weight: normal;
        color: #1c1e21;
        font-size: 1.5rem;
        margin-bottom: 20px;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }

      #post-form {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
      }

      #image-upload {
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccd0d5;
        border-radius: 6px;
        background-color: #f5f6f7;
      }

      #post-caption {
        margin-bottom: 10px;
        padding: 12px;
        border: 1px solid #ccd0d5;
        border-radius: 6px;
        background-color: #f5f6f7;
        font-size: 14px;
      }

      #add-post {
        padding: 10px;
        background-color: #1877f2;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        text-align: center;
      }

      #add-post:hover {
        background-color: #166fe5;
      }

      #posts {
        margin-top: 20px;
      }

      .post {
        background: #ffffff;
        border: 1px solid #dddfe2;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        padding-bottom: 10px;
        position: relative;
      }

      .post img {
        width: 100%;
        border-bottom: 1px solid #dddfe2;
        border-radius: 8px 8px 0 0;
      }

      .post p {
        margin: 10px;
        font-size: 14px;
        color: #1c1e21;
      }

      .post-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 10px;
      }

      .like-button {
        background-color: transparent;
        border: none;
        color: #1877f2;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        display: flex;
        align-items: center;
      }

      .like-button img {
        width: 20px;
        height: 20px;
        margin-right: 5px;
      }

      .like-button:disabled {
        color: #8d949e;
        cursor: default;
      }

      .comments-section {
        padding: 0 10px;
      }

      .comments-section h4 {
        margin: 10px 0;
        font-size: 14px;
        color: #1c1e21;
      }

      .comment {
        margin-bottom: 10px;
        position: relative;
        padding: 10px 50px 10px 10px;
        background-color: #f5f6f7;
        border-radius: 6px;
      }

      .reply {
        margin-left: 20px;
      }

      .comment-input {
        display: flex;
        align-items: center;
        margin-top: 10px;
      }

      .comment-input input {
        flex: 1;
        padding: 8px;
        border: 1px solid #ccd0d5;
        border-radius: 6px;
        background-color: #f5f6f7;
        font-size: 14px;
        margin-right: 10px;
      }

      .comment-input button {
        padding: 8px 12px;
        background-color: #1877f2;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
      }

      .comment-input button:hover {
        background-color: #166fe5;
      }

      .menu-icon {
        position: absolute;
        top: 22px;
        cursor: pointer;
        left: 60px;
      }

      .menu-dropdown {
        display: none;
        position: absolute;
        top: 25px;
        right: 10px;
        background-color: white;
        border: 1px solid #dddfe2;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        z-index: 10;
        width: 100px;
      }

      .menu-dropdown button {
        width: 100%;
        padding: 5px;
        border: none;
        background: none;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        border-bottom: 1px solid #dddfe2;
      }

      .menu-dropdown button:last-child {
        border-bottom: none;
      }

      .menu-dropdown button:hover {
        background-color: #f5f6f7;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>식단 게시판</h1>
      <div id="post-form">
        <input type="file" id="image-upload" accept="image/*" />
        <input
          type="text"
          id="post-caption"
          placeholder="내용을 입력해주세요."
        />
        <button id="add-post">확인</button>
      </div>
      <div id="posts"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
      // Firebase 설정
      const firebaseConfig = {
        apiKey: "AIzaSyCx_AlSQLpW-KpYXpk0M2mDxVb7CZa_xUk",
        authDomain: "diet-king-b567d.firebaseapp.com",
        projectId: "diet-king-b567d",
        storageBucket: "diet-king-b567d.appspot.com",
        messagingSenderId: "11155339798",
        appId: "1:11155339798:web:f689c9f8b8c772c65cc3e4",
        measurementId: "G-9NNCPJMT9M",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // URL에서 파라미터 추출 함수
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        const regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        const results = regex.exec(location.search);
        return results === null
          ? ""
          : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      document.addEventListener("DOMContentLoaded", function () {
        // URL에서 clientId와 trainerId 추출
        const clientId = getUrlParameter("clientId");
        const trainerId = getUrlParameter("trainerId");

        document
          .getElementById("add-post")
          .addEventListener("click", function () {
            const imageInput = document.getElementById("image-upload");
            const captionInput = document.getElementById("post-caption");

            if (imageInput.files && imageInput.files[0]) {
              const reader = new FileReader();
              reader.onload = function (e) {
                const imageUrl = e.target.result;
                addPost(imageUrl, captionInput.value);
              };
              reader.readAsDataURL(imageInput.files[0]);
            }
          });

        async function addPost(imageUrl, caption) {
          try {
            const postsRef = db.collection("posts");
            const newPostRef = await postsRef.add({
              imageUrl: imageUrl,
              caption: caption,
              timestamp: firebase.firestore.Timestamp.now(),
            });

            console.log("Post added with ID: ", newPostRef.id);
            loadPosts(); // 새 게시물 추가 후 게시물 로드
          } catch (error) {
            console.error("Error adding post: ", error);
          }
        }

        async function loadPosts() {
          try {
            const postsContainer = document.getElementById("posts");
            postsContainer.innerHTML = ""; // 기존 게시물 삭제

            const postsRef = db
              .collection("posts")
              .orderBy("timestamp", "desc");
            const snapshot = await postsRef.get();

            snapshot.forEach((doc) => {
              const data = doc.data();
              const postId = doc.id;
              addPostToDOM(data.imageUrl, data.caption, postId);
            });
          } catch (error) {
            console.error("Error loading posts: ", error);
          }
        }

        function addPostToDOM(imageUrl, caption, postId) {
          const postsContainer = document.getElementById("posts");

          const postDiv = document.createElement("div");
          postDiv.className = "post";

          const postImage = document.createElement("img");
          postImage.src = imageUrl;

          const postCaption = document.createElement("p");
          postCaption.textContent = caption;

          const postActions = document.createElement("div");
          postActions.className = "post-actions";

          const likeButton = document.createElement("button");
          likeButton.className = "like-button";
          let liked = false;
          likeButton.innerHTML = `♡ Like`;

          likeButton.addEventListener("click", function () {
            liked = !liked; // liked 상태를 반전시킵니다.
            if (liked) {
              likeButton.innerHTML = `♥ Liked`;
            } else {
              likeButton.innerHTML = `♡ Like`;
            }
          });

          const commentSection = document.createElement("div");
          commentSection.className = "comments-section";

          const commentTitle = document.createElement("h4");
          commentTitle.textContent = "댓글";

          const commentList = document.createElement("div");

          const commentInputDiv = document.createElement("div");
          commentInputDiv.className = "comment-input";

          const commentInput = document.createElement("input");
          commentInput.type = "text";
          commentInput.placeholder = "댓글을 작성하세요.";

          const commentButton = document.createElement("button");
          commentButton.textContent = "작성";
          commentButton.addEventListener("click", function () {
            const commentText = commentInput.value;
            if (commentText.trim() !== "") {
              addComment(commentList, commentText, false, postId);
              commentInput.value = "";
            }
          });

          commentInputDiv.appendChild(commentInput);
          commentInputDiv.appendChild(commentButton);

          commentSection.appendChild(commentTitle);
          commentSection.appendChild(commentList);
          commentSection.appendChild(commentInputDiv);

          postActions.appendChild(likeButton);
          postDiv.appendChild(postImage);
          postDiv.appendChild(postCaption);
          postDiv.appendChild(postActions);
          postDiv.appendChild(commentSection);

          postsContainer.appendChild(postDiv);

          // Load comments for this post
          loadComments(postId, commentList);
        }

        async function addComment(parentElement, commentText, isReply, postId) {
          try {
            const commentsRef = db
              .collection("posts")
              .doc(postId)
              .collection("comments");
            const docRef = await commentsRef.add({
              text: commentText,
              clientId: clientId,
              timestamp: firebase.firestore.Timestamp.now(),
              isReply: isReply,
            });

            console.log("Comment added with ID: ", docRef.id);
            loadComments(postId, parentElement); // Reload comments after adding a new one
          } catch (error) {
            console.error("Error adding comment: ", error);
          }
        }

        async function loadComments(postId, commentList) {
          try {
            commentList.innerHTML = ""; // Clear existing comments

            const commentsRef = db
              .collection("posts")
              .doc(postId)
              .collection("comments")
              .orderBy("timestamp");
            const snapshot = await commentsRef.get();

            snapshot.forEach((doc) => {
              const data = doc.data();
              addCommentToDOM(
                commentList,
                data.text,
                data.clientId,
                data.isReply,
                doc.id,
                postId
              );
            });
          } catch (error) {
            console.error("Error loading comments: ", error);
          }
        }

        function addCommentToDOM(
          parentElement,
          commentText,
          clientId,
          isReply,
          commentId,
          postId
        ) {
          const commentDiv = document.createElement("div");
          commentDiv.className = "comment" + (isReply ? " reply" : "");

          const commentContent = document.createElement("p");
          commentContent.textContent = `${clientId}: ${commentText}`;

          const menuIcon = document.createElement("div");
          menuIcon.className = "menu-icon";
          menuIcon.innerHTML = "⋮";

          const menuDropdown = document.createElement("div");
          menuDropdown.className = "menu-dropdown";

          const replyButton = document.createElement("button");
          replyButton.textContent = "댓글 달기";
          replyButton.addEventListener("click", function () {
            toggleReplyInput(commentDiv, postId);
            closeDropdown(menuDropdown);
          });

          const editButton = document.createElement("button");
          editButton.textContent = "수정";
          editButton.addEventListener("click", function () {
            editComment(commentDiv, commentContent, commentId, postId);
            closeDropdown(menuDropdown);
          });

          const deleteButton = document.createElement("button");
          deleteButton.textContent = "삭제";
          deleteButton.addEventListener("click", function () {
            deleteComment(commentId, postId);
            commentDiv.remove();
            closeDropdown(menuDropdown);
          });

          menuDropdown.appendChild(replyButton);
          menuDropdown.appendChild(editButton);
          menuDropdown.appendChild(deleteButton);

          menuIcon.addEventListener("click", function (event) {
            event.stopPropagation(); // 클릭 이벤트가 부모로 전파되지 않도록 함
            toggleDropdown(menuDropdown);
          });

          commentDiv.appendChild(commentContent);
          commentDiv.appendChild(menuIcon); // 아이콘을 댓글 컨테이너에 추가
          commentDiv.appendChild(menuDropdown);

          parentElement.appendChild(commentDiv);
        }

        function toggleDropdown(menuDropdown) {
          if (menuDropdown.style.display === "block") {
            menuDropdown.style.display = "none";
          } else {
            closeAllDropdowns(); // 다른 모든 드롭다운을 닫습니다.
            menuDropdown.style.display = "block";
          }
        }

        function closeDropdown(menuDropdown) {
          menuDropdown.style.display = "none";
        }

        function closeAllDropdowns() {
          const dropdowns = document.querySelectorAll(".menu-dropdown");
          dropdowns.forEach(function (dropdown) {
            dropdown.style.display = "none";
          });
        }

        function toggleReplyInput(commentDiv, postId) {
          let replyInputDiv = commentDiv.querySelector(".reply-input");
          if (!replyInputDiv) {
            replyInputDiv = document.createElement("div");
            replyInputDiv.className = "comment-input reply-input";

            const replyInput = document.createElement("input");
            replyInput.type = "text";
            replyInput.placeholder = "대댓글을 작성하세요.";

            const replyButton = document.createElement("button");
            replyButton.textContent = "댓글 작성";

            replyButton.addEventListener("click", function () {
              const replyText = replyInput.value;
              if (replyText.trim() !== "") {
                addComment(commentDiv, replyText, true, postId);
                replyInputDiv.remove(); // 대댓글 작성 후 입력창을 제거합니다.
              }
            });

            replyInputDiv.appendChild(replyInput);
            replyInputDiv.appendChild(replyButton);
            commentDiv.appendChild(replyInputDiv);
          } else {
            replyInputDiv.remove();
          }
        }

        function editComment(commentDiv, commentContent, commentId, postId) {
          const originalText = commentContent.textContent.split(": ")[1];
          const editInput = document.createElement("input");
          editInput.type = "text";
          editInput.value = originalText;
          commentContent.replaceWith(editInput);

          editInput.addEventListener("blur", function () {
            updateComment(commentId, postId, editInput.value);
            commentContent.textContent = `${clientId}: ${editInput.value}`;
            editInput.replaceWith(commentContent);
          });

          editInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              updateComment(commentId, postId, editInput.value);
              commentContent.textContent = `${clientId}: ${editInput.value}`;
              editInput.replaceWith(commentContent);
            }
          });

          editInput.focus();
        }

        async function updateComment(commentId, postId, newText) {
          try {
            const commentRef = db
              .collection("posts")
              .doc(postId)
              .collection("comments")
              .doc(commentId);
            await commentRef.update({
              text: newText,
            });

            console.log("Comment updated");
          } catch (error) {
            console.error("Error updating comment: ", error);
          }
        }

        async function deleteComment(commentId, postId) {
          try {
            const commentRef = db
              .collection("posts")
              .doc(postId)
              .collection("comments")
              .doc(commentId);
            await commentRef.delete();

            console.log("Comment deleted");
          } catch (error) {
            console.error("Error deleting comment: ", error);
          }
        }

        // 클릭 시 드롭다운이 아닌 곳을 클릭하면 닫히도록
        document.addEventListener("click", function (event) {
          const target = event.target;
          if (
            !target.classList.contains("menu-icon") &&
            !target.classList.contains("menu-dropdown") &&
            !target.closest(".menu-dropdown")
          ) {
            closeAllDropdowns();
          }
        });

        // 초기 게시물 로드
        loadPosts();
      });
    </script>
  </body>
</html>
