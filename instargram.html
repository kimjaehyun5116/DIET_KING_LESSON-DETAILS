<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>게시판</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 20px;
      }

      .container {
        width: 100%;
        max-width: 600px;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 24px;
        margin-bottom: 20px;
        text-align: center;
      }

      #post-form {
        margin-bottom: 20px;
      }

      #post-form input[type="text"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }

      #post-form input[type="file"] {
        margin-bottom: 10px;
      }

      #post-form button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      #posts {
        margin-top: 20px;
      }

      .post {
        background-color: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .post img {
        max-width: 100%;
        border-radius: 8px;
        margin-bottom: 10px;
      }

      .post p {
        margin: 10px 0;
      }

      .comment-section {
        margin-top: 10px;
      }

      .comment-section input[type="text"] {
        width: 80%;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        margin-right: 5px;
      }

      .comment-section button {
        padding: 8px 12px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .comment {
        background-color: #f9f9f9;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 10px;
        position: relative;
      }

      .comment .menu {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
      }

      .menu-dropdown {
        display: none;
        position: absolute;
        top: 30px;
        right: 10px;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      .menu-dropdown button {
        padding: 5px 10px;
        background: none;
        border: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
      }

      .menu-dropdown button:hover {
        background-color: #f0f0f0;
      }

      .reply {
        margin-left: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>게시판</h1>
      <div id="post-form">
        <input type="file" id="image-upload" accept="image/*" />
        <input type="text" id="post-caption" placeholder="내용을 입력하세요" />
        <button id="add-post">작성</button>
      </div>
      <div id="posts"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <script>
      // Firebase 설정
      const firebaseConfig = {
        apiKey: "AIzaSyCx_AlSQLpW-KpYXpk0M2mDxVb7CZa_xUk",
        authDomain: "diet-king-b567d.firebaseapp.com",
        projectId: "diet-king-b567d",
        storageBucket: "diet-king-b567d.appspot.com",
        messagingSenderId: "11155339798",
        appId: "1:11155339798:web:f689c9f8b8c772c65cc3e4",
        measurementId: "G-9NNCPJMT9M",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const storage = firebase.storage();

      document.addEventListener("DOMContentLoaded", function () {
        const clientId = getUrlParameter("clientId");
        const trainerId = getUrlParameter("trainerId");

        // 게시물 추가
        document
          .getElementById("add-post")
          .addEventListener("click", function () {
            const imageInput = document.getElementById("image-upload");
            const captionInput = document.getElementById("post-caption");

            if (
              imageInput.files.length > 0 &&
              captionInput.value.trim() !== ""
            ) {
              const file = imageInput.files[0];
              const storageRef = storage.ref().child(`images/${file.name}`);
              const uploadTask = storageRef.put(file);

              uploadTask.on(
                "state_changed",
                null,
                function (error) {
                  console.error("이미지 업로드 오류: ", error);
                },
                function () {
                  uploadTask.snapshot.ref
                    .getDownloadURL()
                    .then(function (downloadURL) {
                      addPost(downloadURL, captionInput.value);
                    });
                }
              );
            } else {
              alert("이미지와 내용을 모두 입력하세요.");
            }
          });

        function addPost(imageUrl, caption) {
          const newPost = {
            imageUrl,
            caption,
            clientId,
            trainerId,
            createdAt: new Date(),
          };

          db.collection("posts")
            .add(newPost)
            .then((docRef) => {
              addPostToDOM(imageUrl, caption, docRef.id);
              document.getElementById("post-caption").value = "";
              document.getElementById("image-upload").value = "";
            })
            .catch((error) => {
              console.error("게시물 추가 오류: ", error);
            });
        }

        function addPostToDOM(imageUrl, caption, postId) {
          const postsContainer = document.getElementById("posts");
          const postDiv = document.createElement("div");
          postDiv.className = "post";

          const postImage = document.createElement("img");
          postImage.src = imageUrl;

          const postCaption = document.createElement("p");
          postCaption.textContent = caption;

          const commentSection = document.createElement("div");
          commentSection.className = "comment-section";
          commentSection.dataset.postId = postId;

          const commentInput = document.createElement("input");
          commentInput.type = "text";
          commentInput.placeholder = "댓글을 작성하세요";

          const commentButton = document.createElement("button");
          commentButton.textContent = "작성";

          commentButton.addEventListener("click", function () {
            const commentText = commentInput.value;
            if (commentText.trim() !== "") {
              addCommentToDB(postId, commentText);
              commentInput.value = "";
            }
          });

          commentSection.appendChild(commentInput);
          commentSection.appendChild(commentButton);

          postDiv.appendChild(postImage);
          postDiv.appendChild(postCaption);
          postDiv.appendChild(commentSection);
          postsContainer.appendChild(postDiv);

          loadComments(postId, commentSection);
        }

        function addCommentToDB(postId, text, parentId = null) {
          const newComment = {
            text,
            postId,
            parentId,
            createdAt: new Date(),
          };

          db.collection("comments")
            .add(newComment)
            .then(() => {
              loadComments(
                postId,
                document.querySelector(
                  `.comment-section[data-post-id="${postId}"]`
                )
              );
            })
            .catch((error) => {
              console.error("댓글 추가 오류: ", error);
            });
        }

        function loadComments(postId, section) {
          section
            .querySelectorAll(".comment")
            .forEach((comment) => comment.remove());

          db.collection("comments")
            .where("postId", "==", postId)
            .orderBy("createdAt", "asc")
            .get()
            .then((querySnapshot) => {
              querySnapshot.forEach((doc) => {
                const comment = doc.data();
                const isReply = !!comment.parentId;
                addComment(
                  section,
                  comment.text,
                  isReply,
                  doc.id,
                  comment.parentId
                );
              });
            })
            .catch((error) => {
              console.error("댓글 로드 오류: ", error);
            });
        }

        function addComment(
          section,
          text,
          isReply,
          commentId,
          parentId = null
        ) {
          const commentDiv = document.createElement("div");
          commentDiv.className = "comment";
          if (isReply) {
            commentDiv.classList.add("reply");
          }
          commentDiv.dataset.commentId = commentId;

          const commentText = document.createElement("p");
          commentText.textContent = text;

          const menuIcon = document.createElement("div");
          menuIcon.className = "menu";
          menuIcon.textContent = "⋮";

          const menuDropdown = document.createElement("div");
          menuDropdown.className = "menu-dropdown";

          const editButton = document.createElement("button");
          editButton.textContent = "수정";
          editButton.addEventListener("click", function () {
            const newText = prompt("댓글 수정", text);
            if (newText) {
              updateComment(commentId, newText, section, isReply);
            }
          });

          const deleteButton = document.createElement("button");
          deleteButton.textContent = "삭제";
          deleteButton.addEventListener("click", function () {
            deleteComment(commentId, section);
          });

          const replyButton = document.createElement("button");
          replyButton.textContent = "답글";
          replyButton.addEventListener("click", function () {
            const replyText = prompt("답글 입력");
            if (replyText) {
              addCommentToDB(section.dataset.postId, replyText, commentId);
            }
          });

          menuDropdown.appendChild(editButton);
          menuDropdown.appendChild(deleteButton);
          menuDropdown.appendChild(replyButton);

          menuIcon.appendChild(menuDropdown);
          menuIcon.addEventListener("click", function () {
            menuDropdown.style.display =
              menuDropdown.style.display === "block" ? "none" : "block";
          });

          commentDiv.appendChild(commentText);
          commentDiv.appendChild(menuIcon);
          section.appendChild(commentDiv);

          // 대댓글일 경우, 부모 댓글 바로 아래에 추가
          if (parentId) {
            const parentCommentDiv = section.querySelector(
              `.comment[data-comment-id="${parentId}"]`
            );
            parentCommentDiv && parentCommentDiv.appendChild(commentDiv);
          }
        }

        function updateComment(commentId, newText, section, isReply) {
          db.collection("comments")
            .doc(commentId)
            .update({
              text: newText,
            })
            .then(() => {
              loadComments(section.dataset.postId, section);
            })
            .catch((error) => {
              console.error("댓글 수정 오류: ", error);
            });
        }

        function deleteComment(commentId, section) {
          db.collection("comments")
            .doc(commentId)
            .delete()
            .then(() => {
              loadComments(section.dataset.postId, section);
            })
            .catch((error) => {
              console.error("댓글 삭제 오류: ", error);
            });
        }

        function getUrlParameter(name) {
          name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
          const regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
          const results = regex.exec(location.search);
          return results === null
            ? ""
            : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        function loadPosts() {
          db.collection("posts")
            .orderBy("createdAt", "desc")
            .get()
            .then((querySnapshot) => {
              querySnapshot.forEach((doc) => {
                const post = doc.data();
                addPostToDOM(post.imageUrl, post.caption, doc.id);
              });
            })
            .catch((error) => {
              console.error("게시물 로드 오류: ", error);
            });
        }

        loadPosts();
      });
    </script>
  </body>
</html>
